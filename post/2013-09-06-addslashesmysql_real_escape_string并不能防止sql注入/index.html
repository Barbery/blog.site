<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>addslashes, mysql_real_escape_string并不能防止SQL注入!!! - Barbery&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
  
  <meta name="description" content="先看代码&hellip; &lt;?php header(&#39;Content-Type: text/html; charset=GBK&#39;); $input = chr(0xbf) . chr(0x27) . &#39; OR username = username; /*&#39;; $value = addslashes($input); $sql = &quot;SELECT * FROM users WHERE username=&#39;{$value}&#39; AND password=&#39;123123&#39;;&quot;; echo $value; echo &#39;&lt;br&gt;&#39;; echo $sql; echo &#39;&lt;br&gt;&#39;; 以上的demo, 输出结果为: 你也许会疑问,">
  
  <meta itemprop="name" content="addslashes, mysql_real_escape_string并不能防止SQL注入!!! - Barbery&#39;s Blog">
  <meta itemprop="description" content="先看代码&hellip; &lt;?php header(&#39;Content-Type: text/html; charset=GBK&#39;); $input = chr(0xbf) . chr(0x27) . &#39; OR username = username; /*&#39;; $value = addslashes($input); $sql = &quot;SELECT * FROM users WHERE username=&#39;{$value}&#39; AND password=&#39;123123&#39;;&quot;; echo $value; echo &#39;&lt;br&gt;&#39;; echo $sql; echo &#39;&lt;br&gt;&#39;; 以上的demo, 输出结果为: 你也许会疑问,">
  <meta itemprop="image" content="http://barbery.me/img/author.jpg">
  
  
  <meta name="twitter:description" content="">
  
  <link rel="shortcut icon" href="http://barbery.me/img/favicon.ico"/>
  <link rel="apple-touch-icon" href="http://barbery.me/apple-touch-icon.png" />
  <link rel="apple-touch-icon-precomposed" href="http://barbery.me/apple-touch-icon.png" />
  <link rel="stylesheet" href="http://barbery.me/highlight/styles/github.css">
  <script src="http://barbery.me/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <link rel="stylesheet" href="http://barbery.me/font/hack/css/hack.min.css">
  <link rel="stylesheet" href="http://barbery.me/css/style.css">
</head>

<body>
  <header>
    <div>
  
  <div id="textlogo">
    <h1 class="site-name"><a href="http://barbery.me/" title="Barbery&#39;s Blog">Barbery&#39;s Blog</a></h1>
    <h2 class="blog-motto">夫君子之行，静以修身，俭以养德。非淡泊无以明志，非宁静无以致远。夫学须静也，才须学也</h2>
  </div>
  <div class="navbar"><a class="navbutton navmobile" href="#" title="menu"></a></div>
  <div class="social-font clearfix">
  
  <a href="http://weibo.com/stutostu" target="_blank" title="weibo"></a>
  
  
  
  <a href="https://github.com/Barbery" target="_blank" title="github"></a>
  
  
  
  <a href="https://cn.linkedin.com/in/BarberyXie" target="_blank" title="linkedin"></a>
  
</div>
  <nav class="animated">
    <ul>
      
      <li><a href="/">home</a></li>
      
      <li><a href="/about">about</a></li>
      
      <li><a href="/link">link</a></li>
      
      <li>
        <form class="search" method="get" action="https://www.google.com/search">
          <div>
            <input type="text" id="search" name="q" placeholder="search">
          </div>
        </form>
      </li>
    </ul>
  </nav>
</div>

  </header>
  <div id="container">
    <div id="main" class="post" itemscope itemprop="blogPost" style="width:100%;">
	<article itemprop="articleBody">
    <header class="article-info clearfix">
  <h1 itemprop="name">
      <a href="http://barbery.me/post/2013-09-06-addslashesmysql_real_escape_string%E5%B9%B6%E4%B8%8D%E8%83%BD%E9%98%B2%E6%AD%A2sql%E6%B3%A8%E5%85%A5/" title="addslashes, mysql_real_escape_string并不能防止SQL注入!!!" itemprop="url">addslashes, mysql_real_escape_string并不能防止SQL注入!!!</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://barbery.me" title=""></a>
    
  </p>
  <p class="article-time">
    <time datetime="2013-09-06 21:28:32 &#43;0000 &#43;0000" itemprop="datePublished">2013年09月06日</time>
  </p>
</header>

	<div class="article-content">
    
    

<p>先看代码&hellip;</p>

<pre><code class="language-php">&lt;?php
    header('Content-Type: text/html; charset=GBK');
    $input = chr(0xbf) . chr(0x27) . ' OR username = username; /*';
    $value = addslashes($input);
    $sql = &quot;SELECT * FROM users WHERE username='{$value}' AND password='123123';&quot;;

    echo $value;
    echo '&lt;br&gt;';
    echo $sql;
    echo '&lt;br&gt;';
</code></pre>

<p>以上的demo, 输出结果为:</p>

<p><img src="http://ww3.sinaimg.cn/large/6915c7dcgw1e8d0o3a0l1j20lu02uq3c.jpg" alt="输出结果" /></p>

<p>你也许会疑问, 为什么addslashes没有生效~~ 对于一个单引号 &lsquo; 来说, addslashes 是有效果的, 但是这里不是一个实体的单引号字符.. 我们再看回去$value的赋值</p>

<pre><code>$value = chr(0xbf) . chr(0x27) . ' OR username = username /*';
</code></pre>

<p>chr(0xbf) 和 chr(0x27)相连接, 构成一个双字节字符(0xbf27)… 而0xbf27只是一个人为合成的双字节, 不在GBK编码表里, 也就是说不是一个合法的GBK双字节字符… 系统会把这个双字节拆分为2个单字节解析(也就是0xbf和0x27), 而addslashes并不知道它是非法的双字节字符, 单引号的GBK编码就是chr(0x27), 单独使用使addslashes是可以识别的&hellip;</p>

<p>我使用mysql_real_escape_string测试结果也一样, 无法识别这个非法的GBK双字节字符, 虽然无法识别, 但是使用mysql_query sql却没有绕过mysql的内部系统, 执行结果是空行数&hellip;上网搜了一下, 网友说在mysql 5.0的某个版本被修复鸟~~ 但是mysql的更新链接已经失效, 所以也无法追寻是哪个版本后修复了这个问题… 但是手动复制sql进去phpmyadmin下执行 是可以执行的~~ 知道的朋友, 可以交流下!!</p>

<p>附上测试脚本:<a href="https://github.com/Barbery/blog/blob/master/sql_inject_test.php">https://github.com/Barbery/blog/blob/master/sql_inject_test.php</a></p>

<p>关于上面说的, 大家有什么不懂或需要详细了解, 推荐阅读:</p>

<p><a href="http://shiflett.org/blog/2006/jan/addslashes-versus-mysql-real-escape-string">http://shiflett.org/blog/2006/jan/addslashes-versus-mysql-real-escape-string</a>
<a href="http://ilia.ws/archives/103-mysql_real_escape_string-versus-Prepared-Statements.html">http://ilia.ws/archives/103-mysql_real_escape_string-versus-Prepared-Statements.html</a></p>

<h2 id="解决办法">解决办法</h2>

<p>使用PDO的prepare操作&hellip;</p>

<blockquote>
<p>Prepared statements are 2 round-trips to the database for a single query.
As soon as you prepare a query, it&rsquo;s sent to the database with the placeholders you set. So the database engine takes that prepared statement and maps out the query and optimizes it for execution. Then when you call execute() only the values you give are sent to the database, with a reference to that query you just prepared. The database engine drops in the values and runs the query. This is totally immune to SQL injection, because the database engine already knows exactly where the values begin and end (the placeholder marker(s) you set), and therefore never need escaping.
The reason SQL injection exists in the first place is because the entire query is interpreted upon execution, values and all. So if anything interferes with the quotes surrounding your values, the engine thinks that value has ended earlier than it really should, and thus a security hole is introduced. That problem is avoided entirely with prepared statements by letting the database engine know ahead of time exactly where to put each value you pass to it later on. There is no need for escaping and there is no need to worry.</p>
</blockquote>

<p> </p>

<p> </p>

<p>简单点说就是, 通过PDO的prepared来预处理, PDO在执行1条SQL语句时会发送2条指令, 1是要执行的SQL指令, 但是没有进行赋值, MYSQL对将要处理的SQL进行优化, 然后PDO再发送1条指令, 这条指令就是上条指令需要用到的变量, MYSQL收到后进行赋值然后执行, 这样就可以消除SQL注入&hellip;</p>

<p>再简单点说就是, 例如SQL为:</p>

<pre><code>SELECT * FROM user WHERE username='barbery';
</code></pre>

<p>只发送1条指令的情况下, mysql要从这条SQL中提取出barbery, 所以就会存在没转义, 等的注入攻击..</p>

<p>而如果使用PDO的话, 第一条指令会是这样发送</p>

<pre><code>SELECT * FROM user WHERE username=?;
</code></pre>

<p>然后第二条指令再把变量值 barbery发送过去&hellip;MYSQL接受到第一条指令时就使用编译器进行优化(使用什么索引等等), 就把指令的执行内容和范围给确定了, 后面传过来的值是什么, 都不会影响SQL的执行内容&hellip;</p>

<p>这里建议阅读 <a href="http://zhangxugg-163-com.iteye.com/blog/1835721">http://zhangxugg-163-com.iteye.com/blog/1835721</a> 获得更直观的了解~~</p>

<p> </p>

<p> </p>

<p> </p>

	</div>
  <footer class="article-footer clearfix">
  

<div class="article-tags">
  <span></span>
  
  <a href="http://barbery.me/tags/addslashes">addslashes</a>
  
  <a href="http://barbery.me/tags/mysql_real_escape_string">mysql_real_escape_string</a>
  
  <a href="http://barbery.me/tags/pdo">PDO</a>
  
  <a href="http://barbery.me/tags/php">php</a>
  
  <a href="http://barbery.me/tags/sql%E6%B3%A8%E5%85%A5">SQL注入</a>
  
</div>





<div class="article-categories">
  <span></span>
  
  <a class="article-category-link" href="http://barbery.me/categories/%E5%BC%80%E5%8F%91">开发</a>
  
</div>



  <div class="article-share" id="share">
    <div data-url="http://barbery.me/post/2013-09-06-addslashesmysql_real_escape_string%E5%B9%B6%E4%B8%8D%E8%83%BD%E9%98%B2%E6%AD%A2sql%E6%B3%A8%E5%85%A5/" data-title="addslashes, mysql_real_escape_string并不能防止SQL注入!!!" data-tsina="" class="share clearfix">
    </div>
  </div>
</footer>

	</article>
  



</div>

  </div>
  <footer><div id="footer" >
  
  
  <p class="copyright">Powered by <a href="http://gohugo.io" target="_blank" title="hugo">hugo</a> and Theme by <a href="https://github.com/coderzh/hugo-pacman-theme" target="_blank" title="hugo-pacman-theme">hugo-pacman-theme</a> © 2018
    
    <a href="http://barbery.me/" title="Barbery&#39;s Blog">Barbery&#39;s Blog</a>
    
  </p>
</div>
</footer>
  <script src="http://barbery.me/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
done = false;
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  $('form.search').on('submit', function (event) {
    if (false === done) {
      event.preventDefault();
      var orgVal = $(this).find('#search').val();
      $(this).find('#search').val('site:http:\/\/barbery.me\/ ' + orgVal);
      done = true;
      $(this).submit();
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});
</script>


<link rel="stylesheet" href="http://barbery.me/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="http://barbery.me/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
});
</script>




</body>
</html>
